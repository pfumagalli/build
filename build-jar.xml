<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant">

  <!-- A little macro we can use to jar a target directory up -->
  <macrodef name="-macro:jar" >
    <attribute name="directory"/>
    <sequential>
      <jar destfile="${targetdir}/${ivy.module}-${ivy.revision}-@{directory}.jar"
           basedir="${targetdir}/compile/@{directory}"
           excludes="**/*.java"/>
    </sequential>
  </macrodef>

  <!-- Use JavaScript to JAR up each directory individually -->
  <target name="jar"
          depends="compile"
          unless="task.executed.jar"
          description="Prepare JAR archives for each compiled source directory">
    <property name="task.executed.jar" value="true"/>
    <script language="javascript">
      <![CDATA[
        importClass(java.io.File);

        // Create a dirset and get all the directories in /target/compile
        var targetDir = project.getProperty('targetdir');
        var dirSet = project.createDataType('dirset');
        dirSet.setDir(new File(targetDir + '/compile'));
        dirSet.setIncludes('*');
        var scanner = dirSet.getDirectoryScanner(project);
        var directories = scanner.getIncludedDirectories();

        // Using our macro, jar each directory individually
        var task = project.createTask('-macro:jar');
        for (var x = 0; x < directories.length; x ++) {
          task.setDynamicAttribute('directory', directories[x]);
          task.perform();
        }
      ]]>
    </script>
  </target>
</project>